generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id    Int    @id @default(autoincrement())
  first_name String
  last_name  String
  password   String
  email      String @unique

  // Relations
  user_roles    UserRole[]
  user_jobtitle UserJobTitle[]
  indicators    Indicator[]

  @@map("users")
}

model Role {
  role_id Int    @id @default(autoincrement())
  name    String

  // Relations
  user_roles UserRole[]

  @@map("roles")
}

model UserRole {
  user_id Int
  role_id Int

  // Relations
  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [role_id], onDelete: Cascade)

  @@id([user_id, role_id])
  @@map("user_roles")
}

model JobTitle {
  jobtitle_id Int    @id @default(autoincrement())
  name        String

  // Relations
  user_jobtitle UserJobTitle[]
  responsible_jobtitle ResponsibleJobTitle[]
  
  @@map("job_titles")
}

model UserJobTitle {
  user_id     Int
  jobtitle_id Int

  // Relations
  user     User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  jobtitle JobTitle @relation(fields: [jobtitle_id], references: [jobtitle_id], onDelete: Cascade)

  @@id([user_id, jobtitle_id])
  @@map("user_job_titles")
}

model Category {
  category_id Int       @id @default(autoincrement())
  name        String
  description String?
  user_id     Int
  created_at  DateTime  @default(now())
  updated_at  DateTime? @updatedAt

  // Relations
  indicators Indicator[]

  @@map("categories")
}

model Indicator {
  indicator_id        Int      @id @default(autoincrement())
  name                String
  target_value        Float?
  unit                String?
  frequency_id        Int
  date                DateTime?
  status              String?
  main_indicator_id   Int?
  category_id         Int
  user_id             Int
  position            Int

  // --- Corrected Self-Relation ---
  main_indicator      Indicator?            @relation("MainSubIndicators", fields: [main_indicator_id], references: [indicator_id])
  sub_indicators      Indicator[]           @relation("MainSubIndicators")

  // Relations
  category           Category             @relation(fields: [category_id], references: [category_id], onDelete: Cascade)
  user               User                 @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  frequency          Frequency            @relation(fields: [frequency_id], references: [frequency_id], onDelete: Cascade)
  responsible_jobtitle ResponsibleJobTitle[]
  indicator_data      IndicatorData[] 

  @@unique([category_id, position, main_indicator_id], map: "indicator_position_unique")

  @@map("indicators")
}

model ResponsibleJobTitle {
  indicator_id Int
  jobtitle_id  Int

  // Relations
  indicator Indicator @relation(fields: [indicator_id], references: [indicator_id], onDelete: Cascade)
  jobtitle  JobTitle  @relation(fields: [jobtitle_id], references: [jobtitle_id], onDelete: Cascade)

  @@id([indicator_id, jobtitle_id])
  @@map("responsible_jobTitles")
}

model Frequency {
  frequency_id      Int    @id @default(autoincrement())
  name              String // เช่น รายเดือน, รายปี, รายเทอม, ไตรมาส
  periods_in_year   Int    @default(1) // 12 1 4 6 9
  
  // Relations
  indicators Indicator[]
  periods    Period[]
  
  @@map("frequencies")
}

model Period {
  period_id    Int      @id @default(autoincrement())
  start_date   DateTime
  end_date     DateTime
  frequency_id Int
  
  // Relations
  frequency Frequency @relation(fields: [frequency_id], references: [frequency_id], onDelete: Cascade)
  
  indicator_data IndicatorData[]
  
  @@map("periods")
}

model IndicatorData {
  indicatordata_id Int      @id @default(autoincrement())
  indicator_id     Int
  period_id        Int
  actual_value     Float?
  created_at       DateTime @default(now())
  updated_at       DateTime? @updatedAt

  // Relations
  indicator Indicator @relation(fields: [indicator_id], references: [indicator_id], onDelete: Cascade)
  period    Period    @relation(fields: [period_id], references: [period_id], onDelete: Cascade)

  @@unique([indicator_id, period_id]) // ensure one record per indicator per period
  @@map("indicator_data")
}
